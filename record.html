<!DOCTYPE html>
<html>

    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link
            href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700;900&display=swap"
            rel="stylesheet">
        <script
            src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.17/angular.min.js"></script>
        <script
            src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
        <title>Hồ sơ hệ thống</title>
        <link rel="stylesheet" href="./css/themify-icons/themify-icons.css">
        <link rel="stylesheet" href="./css/style.css">
        <link rel="stylesheet" href="./css/homepage.css">
    </head>

    <body ng-app="myapp" ng-controller="recordController" onload="startTime();
        startTime1();">
        <div class="container">
            <div class="content-body">
                <!-- menu bar bên trái -->
                <div class="menu-bar">
                    <h1 class="menu-title">
                        Menu
                    </h1>
                    <div>
                        <i class="ti-user"></i>
                        <a href="profile.html">
                            <div class="menu-btn">Tài khoản</div>
                        </a>
                    </div>
                    <div>
                        <i class="ti-settings"></i>
                        <a href="setting.html">
                            <div class="menu-btn">Cài đặt</div>
                        </a>
                    </div>
                    <div>
                        <i class="ti-notepad"></i>
                        <a href="record.html">
                            <div class="menu-btn">Hồ sơ hệ thống</div>
                        </a>
                    </div>
                    <div>
                        <i class="ti-support"></i>
                        <a href="guide.html">
                            <div class="menu-bt">Hướng dẫn sử dụng</div>
                        </a>
                    </div>



                </div>

                <!-- phần chính bên phải -->
                <div class="main-content">
                    <!-- thanh header bên trên -->
                    <div class="header-bar">
                        <div class="search-bar">
                            <input type="text" placeholder="Search..">
                        </div>
                        <a href="homepage.html">
                            <div class="header-btn">Trang chủ</div>
                        </a>
                        <a href="#">
                            <div class="header-btn">Về chúng tôi</div>
                        </a>
                        <a href="#">
                            <div class="header-btn">Hỗ trợ</div>
                        </a>
                        <div class="account-btn">
                            <i class="ti-user"></i>
                            <div class="account-name">{{userName}}</div>
                            <i class="ti-angle-down" onclick="openUserMenu()"></i>
                            <i class="ti-angle-up" onclick="closeUserMenu()"></i>
                        </div>

                        <!-- user menu -->
                        <div class="user-menu">
                            <div class="user-btn" id="profile-btn"
                                onclick="window.location= 'profile.html';">
                                Hồ sơ
                            </div>
                            <div class="user-btn" id="logout-btn">
                                Đăng xuất
                            </div>
                        </div>
                    </div>

                    <!-- Phần nội dung và thông báo -->
                    <div class="info-and-noti" >
                        <div class="info" style="overflow: auto;">
                            <div class="sensor-info" >
                                <div class="sensor-temp">
                                    Hồ sơ hệ thống
                                </div>
                            </div>
                            <hr style="width:100%;text-align:left;margin-left:1"
                                />
                            <div style="display:{{viewGeneral}}" >
                                <div ng-repeat="item in items track by $index">
                                    <div class="info-btns_record"
                                        ng-click="viewDetailR($index)">
                                        Hồ sơ hệ thống ngày {{
                                        item.date.substring(6,8)+"/"+item.date.substring(4,6)+"/"+item.date.substring(0,4)}}
                                    </div>
                                </div>
                            </div>
                            <div style="display:{{viewDetail}};">
                                <table class="table-view">
                                    <thead>
                                        <tr>
                                            <th>Thời gian</th>
                                            <th>Nhiệt độ (&deg;C)</th>
                                            <th>Độ ẩm (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="item in detailData.data.temp track by $index">
                                            <td>{{item.created_at}}</td>
                                            <td>{{item.value}}</td>
                                            <td>{{detailData.data.hummid[$index].value}}</td>
                                        </tr>
                                    </tbody>
                                    
                                </table>
                                <button class="info-btns_record"
                                ng-click="back()"> Quay lại</button>
                            </div>
                            
                        </div>

                        <!-- Thông báo -->
                        <div class="noti"  style="overflow: auto;">
                            <div class="date-time" id="curr-date-time"
                                style="margin-bottom: 20px;">
                                <h2 id="curr-time"></h2>
                                <h3 id="curr-date"></h3>
                            </div>
                            <h3 style="margin-bottom: 20px;">Thông tin kiểm tra
                                hệ thống</h3>
                            <div ng-repeat="noti in notices">
                                <div class="noti-description">
                                    <div class="noti-time"
                                        style="font-size:22px;padding-bottom: 10px;">
                                        - {{noti.created_at}}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    function startTime() {
                    const today = new Date();
                    let h = today.getHours();
                    let m = today.getMinutes();
                    let s = today.getSeconds();
                    m = checkTime(m);
                    s = checkTime(s);
                    document.getElementById('curr-date').innerHTML =  h + ":" + m + ":" + s;
                    setTimeout(startTime, 1000);
                }
                function startTime1() {
                    const today = new Date();
                    let d = today.getDate();
                    let m = today.getMonth()+1;
                    let y = today.getFullYear();
                    m = checkTime(m);
                    d = checkTime(d);
                    document.getElementById('curr-time').innerHTML =  d + "/" + m + "/" + y;
                    setTimeout(startTime, 8640000000);
                }
                function checkTime(i) {
                    if (i < 10) {i = "0" + i};  // add zero in front of numbers < 10
                    return i;
                }

                angular.module("myapp", [])
                    .controller("recordController", function($scope,$http) {
                        $scope.viewDetail="none";
                        $scope.viewGeneral="block";
                        $scope.detailData=null;
                        var today = new Date();
                        $scope.timeNow = today.getHours() + ":" + today.getMinutes();
                        $scope.dateNow = today.getDate() + "/" + (today.getMonth() + 1) + "/" + today.getFullYear();
                        $scope.userName = "Phạm Công Hậu";
                        $scope.notices=[];
                        function takeTime(){
                        $http.get('http://127.0.0.1:5000/time').
                         success(function(data, status, headers, config) {
                            $scope.notices=JSON.parse(data["time"]);
                            console.log($scope.notices);
                            for(var i=0;i<$scope.notices.length;i++){
                                var date= new Date($scope.notices[i].created_at);
                                var s=checkTime(date.getSeconds());
                                var m=checkTime(date.getMinutes());
                                var h=checkTime(date.getHours());
                                var d=checkTime(date.getDate());
                                var M= checkTime((date.getMonth() + 1));
                                var y=date.getFullYear();
                                var timeN= d+ "/" + M + "/" + y +"   "+h+ ":" + m+":"+s;
                                $scope.notices[i].created_at=timeN;
                            }
                        }).
                        error(function(data, status, headers, config) {
                        });
                        }
                    
                        $scope.items=[];
                        takeTime();
                        $scope.listTemp = "";
                        $scope.listHummid= "";
                        function getData(){
                            $http.get('http://127.0.0.1:5000/check1').
                         success(function(data, status, headers, config) {
                            
                            $scope.listTemp=JSON.parse(data["temp"]);
                            $scope.listHummid=JSON.parse(data["hummid"]);
                            var list_data=$scope.listTemp.concat($scope.listHummid);
                            var list_date=[];
                            for( var i=0;i<list_data.length;i++){
                                var date= new Date(list_data[i].created_at);
                                var d=checkTime(date.getDate());
                                var M= checkTime((date.getMonth() + 1));
                                var y=date.getFullYear();
                                var timeN= y+M+d;
                                if(!haveElement(list_date,timeN)){
                                    list_date.push(timeN);
                                }
                            }
                            list_date.sort();
                            for(var i=0;i<list_date.length;i++){
                                $scope.items.push({date:list_date[i],data:{temp:[],hummid:[]}});
                            }
                            for(var j=0;j<$scope.items.length;j++){
                                for(var i=0;i<$scope.listTemp.length;i++){
                                    var date= new Date($scope.listTemp[i].created_at);
                                    var d=checkTime(date.getDate());
                                    var M= checkTime((date.getMonth() + 1));
                                    var y=date.getFullYear();
                                    var timeN= y+M+d;
                                    if($scope.items[j].date==timeN){
                                        $scope.items[j].data.temp.push($scope.listTemp[i]);
                                        $scope.items[j].data.hummid.push($scope.listHummid[i]);
                                    }
                                }
                            }
                            for(var i=0;i<$scope.listTemp.length;i++){
                                var date= new Date($scope.listTemp[i].created_at);
                                var s=checkTime(date.getSeconds());
                                var m=checkTime(date.getMinutes());
                                var h=checkTime(date.getHours());
                                var d=checkTime(date.getDate());
                                var M= checkTime((date.getMonth() + 1));
                                var y=date.getFullYear();
                                var timeN= d+ "/" + M + "/" + y +"   "+h+ ":" + m+":"+s;
                                $scope.listTemp[i].created_at=timeN;
                                $scope.listTemp[i].value=Math.round($scope.listTemp[i].value * 100) / 100 ;
                                $scope.listHummid[i].created_at=timeN;
                                $scope.listHummid[i].value=Math.round($scope.listHummid[i].value * 100) / 100 ;
                            }
                        }).
                        error(function(data, status, headers, config) {
                        });
                        }
                        getData();
                        function haveElement(lst,ele){
                            for (var i=0;i<lst.length;i++){
                                if(lst[i]==ele){
                                    return true;
                                }
                            }
                            return false;
                        }
                        $scope.viewDetailR=function(idx){
                            $scope.viewGeneral="none";
                            $scope.viewDetail="block";
                            $scope.detailData=$scope.items[idx];
                            console.log($scope.detailData);
                        }
                        $scope.back=function(){
                            $scope.detailData=null;
                            $scope.viewGeneral="block";
                            $scope.viewDetail="none";
                        }
                    });
            </script>
            </div>

            <!-- footer bên dưới -->
            <div class="footer">
                <a href="#">Sản phẩm</a>
                <a href="#">Dịch vụ và điều khoản</a>
                <a href="#">Hổ trợ</a>
                <a href="#">Về chúng tôi</a>
            </div>
        </div>
        <script src="./js/userMenu.js"></script>
    </body>

</html>